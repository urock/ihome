###############################################################################
#
# IAR ANSI C/C++ Compiler V7.20.2.7424/W32 for ARM        26/Sep/2014  17:06:43
# Copyright 1999-2014 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\src\stm32f2x7_eth_bsp.c
#    Command line =  
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\src\stm32f2x7_eth_bsp.c
#        -D USE_STDPERIPH_DRIVER -D STM32F2XX -D USE_STM322xG_EVAL -lcN
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\STM322xG_EVAL\List\
#        -o
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\STM322xG_EVAL\Obj\
#        --no_cse --no_unroll --no_inline --no_code_motion --no_tbaa
#        --no_clustering --no_scheduling --debug --endian=little
#        --cpu=Cortex-M3 -e --fpu=None --dlib_config "C:\Program Files
#        (x86)\IAR Systems\Embedded Workbench
#        7.0_2\arm\INC\c\DLib_Config_Full.h" -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\inc\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Libraries\CMSIS\CM3\DeviceSupport\ST\STM32F2xx\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Libraries\STM32F2xx_StdPeriph_Driver\inc\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Libraries\STM32F2x7_ETH_Driver\inc\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\STM32_EVAL\Common\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\STM32_EVAL\STM322xG_EVAL\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\src\include\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\src\include\lwip\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\src\include\netif\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\src\include\ipv4\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\port\STM32F2x7\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\lwip_v1.3.2\port\STM32F2x7\FreeRTOS\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\FreeRTOS_v7.4.2\portable\IAR\ARM_CM3\
#        -I
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\..\..\..\..\Utilities\Third_Party\FreeRTOS_v7.4.2\include\
#        -On --use_c++_inline -I "C:\Program Files (x86)\IAR Systems\Embedded
#        Workbench 7.0_2\arm\CMSIS\Include\"
#    List file    =  
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\STM322xG_EVAL\List\stm32f2x7_eth_bsp.lst
#    Object file  =  
#        C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\EWARM\STM322xG_EVAL\Obj\stm32f2x7_eth_bsp.o
#
###############################################################################

C:\ihome\MCU\STM\trunk\mcu_main\IAR\Project\FreeRTOS\httpserver_netconn\src\stm32f2x7_eth_bsp.c
      1          /**
      2            ******************************************************************************
      3            * @file    stm32f2x7_eth_bsp.c
      4            * @author  MCD Application Team
      5            * @version V1.1.0
      6            * @date    07-October-2011 
      7            * @brief   STM32F2x7 Ethernet hardware configuration.
      8            ******************************************************************************
      9            * @attention
     10            *
     11            * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS
     12            * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE
     13            * TIME. AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY
     14            * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING
     15            * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE
     16            * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.
     17            *
     18            * <h2><center>&copy; COPYRIGHT 2011 STMicroelectronics</center></h2>
     19            ******************************************************************************
     20            */
     21          
     22          /* Includes ------------------------------------------------------------------*/
     23          #include "stm32f2x7_eth.h"
     24          #include "stm32f2x7_eth_bsp.h"
     25          #include "main.h"
     26          
     27          #define CHECKSUM_BY_HARDWARE 1 
     28          
     29          /* Private typedef -----------------------------------------------------------*/
     30          /* Private define ------------------------------------------------------------*/
     31          /* Private macro -------------------------------------------------------------*/
     32          /* Private variables ---------------------------------------------------------*/
     33          __IO uint32_t  EthInitStatus = 0;
     34          __IO uint8_t EthLinkStatus = 0;
     35          
     36          /* Private function prototypes -----------------------------------------------*/
     37          static void ETH_GPIO_Config(void);
     38          static void ETH_NVIC_Config(void);
     39          static void ETH_MACDMA_Config(void);
     40          
     41          /* Private functions ---------------------------------------------------------*/
     42          
     43          /**
     44            * @brief  ETH_BSP_Config
     45            * @param  None
     46            * @retval None
     47            */
     48          void ETH_BSP_Config(void)
     49          {
     50            /* Configure the GPIO ports for ethernet pins */
     51            ETH_GPIO_Config();
     52            
     53            /* Config NVIC for Ethernet */
     54            ETH_NVIC_Config();
     55          
     56            /* Configure the Ethernet MAC/DMA */
     57            ETH_MACDMA_Config();
     58          
     59          //--!sergey begin --
     60          //  /* Configure the PHY to generate an interrupt on change of link status */
     61          //  Eth_Link_PHYITConfig(DP83848_PHY_ADDRESS);
     62          //
     63          //  /* Configure the EXTI for Ethernet link status. */
     64          //  Eth_Link_EXTIConfig();
     65          //--sergey end --  
     66          }
     67          
     68          /**
     69            * @brief  Configures the Ethernet Interface
     70            * @param  None
     71            * @retval None
     72            */
     73          static void ETH_MACDMA_Config(void)
     74          {
     75            ETH_InitTypeDef ETH_InitStructure;
     76          
     77            /* Enable ETHERNET clock  */
     78          //--!sergey begin  
     79          //  SYSCFG_CompensationCellCmd(ENABLE); 
     80          //  RCC_AHB2PeriphClockCmd(RCC_AHB2Periph_HASH, ENABLE);
     81          //--sergey end  
     82            RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_ETH_MAC | RCC_AHB1Periph_ETH_MAC_Tx |
     83                                   RCC_AHB1Periph_ETH_MAC_Rx | RCC_AHB1Periph_CRC, ENABLE);                                             
     84          
     85            /* Reset ETHERNET on AHB Bus */
     86            ETH_DeInit();
     87          
     88            /* Software reset */
     89            ETH_SoftwareReset();
     90          
     91            /* Wait for software reset */
     92            while (ETH_GetSoftwareResetStatus() == SET);
     93          
     94            /* ETHERNET Configuration --------------------------------------------------*/
     95            /* Call ETH_StructInit if you don't like to configure all ETH_InitStructure parameter */
     96            ETH_StructInit(&ETH_InitStructure);
     97          
     98            /* Fill ETH_InitStructure parametrs */
     99            /*------------------------   MAC   -----------------------------------*/
    100            ETH_InitStructure.ETH_AutoNegotiation = ETH_AutoNegotiation_Enable;
    101            //ETH_InitStructure.ETH_AutoNegotiation = ETH_AutoNegotiation_Disable; 
    102            //  ETH_InitStructure.ETH_Speed = ETH_Speed_10M;
    103            //  ETH_InitStructure.ETH_Mode = ETH_Mode_FullDuplex;   
    104          
    105            ETH_InitStructure.ETH_LoopbackMode = ETH_LoopbackMode_Disable;
    106            ETH_InitStructure.ETH_RetryTransmission = ETH_RetryTransmission_Disable;
    107            ETH_InitStructure.ETH_AutomaticPadCRCStrip = ETH_AutomaticPadCRCStrip_Disable;
    108            ETH_InitStructure.ETH_ReceiveAll = ETH_ReceiveAll_Disable;
    109            ETH_InitStructure.ETH_BroadcastFramesReception = ETH_BroadcastFramesReception_Enable;
    110            ETH_InitStructure.ETH_PromiscuousMode = ETH_PromiscuousMode_Disable;
    111            ETH_InitStructure.ETH_MulticastFramesFilter = ETH_MulticastFramesFilter_Perfect;
    112            ETH_InitStructure.ETH_UnicastFramesFilter = ETH_UnicastFramesFilter_Perfect;
    113          #ifdef CHECKSUM_BY_HARDWARE
    114            ETH_InitStructure.ETH_ChecksumOffload = ETH_ChecksumOffload_Enable;
    115          #endif
    116          
    117            /*------------------------   DMA   -----------------------------------*/  
    118            
    119            /* When we use the Checksum offload feature, we need to enable the Store and Forward mode: 
    120            the store and forward guarantee that a whole frame is stored in the FIFO, so the MAC can insert/verify the checksum, 
    121            if the checksum is OK the DMA can handle the frame otherwise the frame is dropped */
    122            ETH_InitStructure.ETH_DropTCPIPChecksumErrorFrame = ETH_DropTCPIPChecksumErrorFrame_Enable; 
    123            ETH_InitStructure.ETH_ReceiveStoreForward = ETH_ReceiveStoreForward_Enable;         
    124            ETH_InitStructure.ETH_TransmitStoreForward = ETH_TransmitStoreForward_Enable;     
    125           
    126            ETH_InitStructure.ETH_ForwardErrorFrames = ETH_ForwardErrorFrames_Disable;       
    127            ETH_InitStructure.ETH_ForwardUndersizedGoodFrames = ETH_ForwardUndersizedGoodFrames_Disable;   
    128            ETH_InitStructure.ETH_SecondFrameOperate = ETH_SecondFrameOperate_Enable;
    129            ETH_InitStructure.ETH_AddressAlignedBeats = ETH_AddressAlignedBeats_Enable;      
    130            ETH_InitStructure.ETH_FixedBurst = ETH_FixedBurst_Enable;                
    131            ETH_InitStructure.ETH_RxDMABurstLength = ETH_RxDMABurstLength_32Beat;          
    132            ETH_InitStructure.ETH_TxDMABurstLength = ETH_TxDMABurstLength_32Beat;
    133            ETH_InitStructure.ETH_DMAArbitration = ETH_DMAArbitration_RoundRobin_RxTx_2_1;
    134          
    135            /* Configure Ethernet */
    136            EthInitStatus = ETH_Init(&ETH_InitStructure, DP83848_PHY_ADDRESS);
    137          
    138            /* Enable the Ethernet Rx Interrupt */
    139            ETH_DMAITConfig(ETH_DMA_IT_NIS | ETH_DMA_IT_R, ENABLE);
    140          }
    141          
    142          /**
    143            * @brief  Configures the different GPIO ports.
    144            * @param  None
    145            * @retval None
    146            */
    147          void ETH_GPIO_Config(void)
    148          {
    149            GPIO_InitTypeDef GPIO_InitStructure;
    150          /* Enable GPIOs clocks */  
    151          
    152            RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA | RCC_AHB1Periph_GPIOB |
    153                                   RCC_AHB1Periph_GPIOC | RCC_AHB1Periph_GPIOD |
    154                                   RCC_AHB1Periph_GPIOE, ENABLE);
    155            
    156            /* Enable SYSCFG clock */
    157            RCC_APB2PeriphClockCmd(RCC_APB2Periph_SYSCFG, ENABLE);
    158            /* Configure MCO (PA8) */
    159            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;
    160            GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    161            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    162            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    163            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
    164            GPIO_Init(GPIOA, &GPIO_InitStructure);
    165          
    166            /* MII/RMII Media interface selection --------------------------------------*/
    167          #ifdef MII_MODE /* Mode MII with STM322xG-EVAL  */
    168           #ifdef PHY_CLOCK_MCO
    169          
    170            /* Output HSE clock (25MHz) on MCO pin (PA8) to clock the PHY */
    171            RCC_MCO1Config(RCC_MCO1Source_HSE, RCC_MCO1Div_1);
    172           #endif /* PHY_CLOCK_MCO */
    173          
    174            SYSCFG_ETH_MediaInterfaceConfig(SYSCFG_ETH_MediaInterface_MII);
    175          #elif defined RMII_MODE  /* Mode RMII with STM322xG-EVAL */
    176            
    177          /* Output PLL clock divided by 2 (50MHz) on MCO pin (PA8) to clock the PHY */
    178          //  RCC_MCO1Config(RCC_MCO1Source_PLLCLK, RCC_MCO1Div_2);
    179            SYSCFG_ETH_MediaInterfaceConfig(SYSCFG_ETH_MediaInterface_RMII);    
    180            SYSCFG_CompensationCellCmd(ENABLE);
    181          #endif
    182          
    183          /* Ethernet pins configuration ************************************************/
    184             /*
    185                  ETH_MDIO -------------------------> PA2  --my +
    186                  ETH_MDC --------------------------> PC1  --my +
    187                  ETH_MII_RX_CLK/ETH_RMII_REF_CLK---> PA1  --my +
    188                  ETH_MII_RX_DV/ETH_RMII_CRS_DV ----> PA7  --my +
    189                  ETH_MII_RXD0/ETH_RMII_RXD0 -------> PC4  --my +
    190                  ETH_MII_RXD1/ETH_RMII_RXD1 -------> PC5  --my +
    191                  ETH_MII_RX_ERR              ----->  PB10  --my pb10 Обязательно нужен
    192                  ETH_MII_TX_EN/ETH_RMII_TX_EN -----> PB11  --my pb11
    193                  ETH_MII_TXD0/ETH_RMII_TXD0 -------> PB13  --my pb12
    194                  ETH_MII_TXD1/ETH_RMII_TXD1 -------> PB14  --my pb13
    195                                                            */
    196            /* Configure PA1, PA2 and PA7 */
    197          //--------------------------------------
    198          //   /* Configure PA1 */	
    199            GPIO_StructInit(&GPIO_InitStructure);
    200            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1;
    201            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    202            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    203            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    204            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    205            GPIO_Init(GPIOA, &GPIO_InitStructure);
    206            GPIO_PinAFConfig(GPIOA, GPIO_PinSource1, GPIO_AF_ETH);
    207          //---------PA2
    208            GPIO_StructInit(&GPIO_InitStructure);
    209            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;
    210            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    211            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    212            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    213            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    214            GPIO_Init(GPIOA, &GPIO_InitStructure);
    215            GPIO_PinAFConfig(GPIOA, GPIO_PinSource2, GPIO_AF_ETH);
    216            //---------PA7
    217            GPIO_StructInit(&GPIO_InitStructure);
    218            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_7;
    219            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    220            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    221            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    222            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    223            GPIO_Init(GPIOA, &GPIO_InitStructure);
    224            GPIO_PinAFConfig(GPIOA, GPIO_PinSource7, GPIO_AF_ETH);
    225          //---------------------------------------  
    226          //   /* Configure PB10 */	
    227            GPIO_StructInit(&GPIO_InitStructure);
    228            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;
    229            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    230            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    231            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    232            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    233            GPIO_Init(GPIOB, &GPIO_InitStructure);
    234            GPIO_PinAFConfig(GPIOB, GPIO_PinSource10, GPIO_AF_ETH);
    235            
    236          //   /* Configure PB11 */	
    237            GPIO_StructInit(&GPIO_InitStructure);
    238            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;
    239            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    240            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    241            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    242            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    243            GPIO_Init(GPIOB, &GPIO_InitStructure);
    244            GPIO_PinAFConfig(GPIOB, GPIO_PinSource11, GPIO_AF_ETH);
    245          
    246          //----------PB12
    247          //   /* Configure PB11 */	
    248            GPIO_StructInit(&GPIO_InitStructure);
    249            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12;
    250            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    251            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    252            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    253            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    254            GPIO_Init(GPIOB, &GPIO_InitStructure);
    255            GPIO_PinAFConfig(GPIOB, GPIO_PinSource12, GPIO_AF_ETH);
    256          //---PB13
    257          //   /* Configure PB11 */	
    258            GPIO_StructInit(&GPIO_InitStructure);
    259            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_13;
    260            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    261            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    262            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    263            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    264            GPIO_Init(GPIOB, &GPIO_InitStructure);
    265            GPIO_PinAFConfig(GPIOB, GPIO_PinSource13, GPIO_AF_ETH);
    266          //-----------------------------------  
    267          //   /* Configure PC1 */	
    268            GPIO_StructInit(&GPIO_InitStructure);
    269            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1;
    270            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    271            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    272            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    273            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    274            GPIO_Init(GPIOC, &GPIO_InitStructure);
    275            GPIO_PinAFConfig(GPIOC, GPIO_PinSource1, GPIO_AF_ETH);
    276          //-----PC4
    277            GPIO_StructInit(&GPIO_InitStructure);
    278            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;
    279            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    280            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    281            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    282            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    283            GPIO_Init(GPIOC, &GPIO_InitStructure);
    284            GPIO_PinAFConfig(GPIOC, GPIO_PinSource4, GPIO_AF_ETH);
    285          //----PC5
    286            GPIO_StructInit(&GPIO_InitStructure);
    287            GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5;
    288            GPIO_InitStructure.GPIO_Speed	= GPIO_Speed_100MHz;
    289            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    290            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    291            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    292            GPIO_Init(GPIOC, &GPIO_InitStructure);
    293            GPIO_PinAFConfig(GPIOC, GPIO_PinSource5, GPIO_AF_ETH);
    294          //---------------------------------------------  
    295          }
    296          
    297          /**
    298            * @brief  Configures and enable the Ethernet global interrupt.
    299            * @param  None
    300            * @retval None
    301            */
    302          void ETH_NVIC_Config(void)
    303          {
    304            NVIC_InitTypeDef   NVIC_InitStructure;
    305          
    306            /* 2 bit for pre-emption priority, 2 bits for subpriority */
    307            NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); 
    308            
    309            /* Enable the Ethernet global Interrupt */
    310            NVIC_InitStructure.NVIC_IRQChannel = ETH_IRQn;
    311            NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;
    312            NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    313            NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    314            NVIC_Init(&NVIC_InitStructure);    
    315          }
    316          
    317          /**
    318            * @brief  Configure the PHY to generate an interrupt on change of link status.
    319            * @param PHYAddress: external PHY address  
    320            * @retval None
    321            */
    322          uint32_t Eth_Link_PHYITConfig(uint16_t PHYAddress)
    323          {
    324            uint32_t tmpreg = 0;
    325          
    326            /* Read MICR register */
    327            tmpreg = ETH_ReadPHYRegister(PHYAddress, PHY_MICR);
    328          
    329            /* Enable output interrupt events to signal via the INT pin */
    330            tmpreg |= (uint32_t)PHY_MICR_INT_EN | PHY_MICR_INT_OE;
    331            if(!(ETH_WritePHYRegister(PHYAddress, PHY_MICR, tmpreg)))
    332            {
    333              /* Return ERROR in case of write timeout */
    334              return ETH_ERROR;
    335            }
    336          
    337            /* Read MISR register */
    338            tmpreg = ETH_ReadPHYRegister(PHYAddress, PHY_MISR);
    339          
    340            /* Enable Interrupt on change of link status */
    341            tmpreg |= (uint32_t)PHY_MISR_LINK_INT_EN;
    342            if(!(ETH_WritePHYRegister(PHYAddress, PHY_MISR, tmpreg)))
    343            {
    344              /* Return ERROR in case of write timeout */
    345              return ETH_ERROR;
    346            }
    347            /* Return SUCCESS */
    348            return ETH_SUCCESS;   
    349          }
    350          
    351          /**
    352            * @brief  EXTI configuration for Ethernet link status.
    353            * @param PHYAddress: external PHY address  
    354            * @retval None
    355            */
    356          void Eth_Link_EXTIConfig(void)
    357          {
    358            GPIO_InitTypeDef GPIO_InitStructure;
    359            EXTI_InitTypeDef EXTI_InitStructure;
    360            NVIC_InitTypeDef NVIC_InitStructure;
    361          
    362            /* Enable the INT (PB14) Clock */
    363            RCC_AHB1PeriphClockCmd(ETH_LINK_GPIO_CLK, ENABLE);
    364            RCC_APB2PeriphClockCmd(RCC_APB2Periph_SYSCFG, ENABLE);
    365          
    366            /* Configure INT pin as input */
    367            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN;
    368            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    369            GPIO_InitStructure.GPIO_Pin = ETH_LINK_PIN;
    370            GPIO_Init(ETH_LINK_GPIO_PORT, &GPIO_InitStructure);
    371          
    372            /* Connect EXTI Line to INT Pin */
    373            SYSCFG_EXTILineConfig(ETH_LINK_EXTI_PORT_SOURCE, ETH_LINK_EXTI_PIN_SOURCE);
    374          
    375            /* Configure EXTI line */
    376            EXTI_InitStructure.EXTI_Line = ETH_LINK_EXTI_LINE;
    377            EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
    378            EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;  
    379            EXTI_InitStructure.EXTI_LineCmd = ENABLE;
    380            EXTI_Init(&EXTI_InitStructure);
    381          
    382            /* Enable and set the EXTI interrupt to the highest priority */
    383            NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);  
    384            NVIC_InitStructure.NVIC_IRQChannel = EXTI15_10_IRQn;
    385            NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
    386            NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    387            NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    388            NVIC_Init(&NVIC_InitStructure);
    389          }
    390          
    391          /**
    392            * @brief  This function handles Ethernet link status.
    393            * @param  None
    394            * @retval None
    395            */
    396          void Eth_Link_ITHandler(uint16_t PHYAddress)
    397          {
    398            /* Check whether the link interrupt has occurred or not */
    399            if(((ETH_ReadPHYRegister(PHYAddress, PHY_MISR)) & PHY_LINK_STATUS) != 0)
    400            {
    401              EthLinkStatus = ~EthLinkStatus;
    402          
    403          #ifdef USE_LCD
    404          //    /* Set the LCD Text Color */
    405          //    LCD_SetTextColor(Red);
    406          //
    407          //    if(EthLinkStatus != 0)
    408          //    {
    409          //      /* Display message on the LCD */
    410          //      LCD_DisplayStringLine(Line5, (uint8_t*)"  Network Cable is  ");
    411          //      LCD_DisplayStringLine(Line6, (uint8_t*)"     unplugged      ");
    412          //    }
    413          //    else
    414          //    {
    415          //      /* Display message on the LCD */
    416          //      LCD_DisplayStringLine(Line5, (uint8_t*)"  Network Cable is  ");
    417          //      LCD_DisplayStringLine(Line6, (uint8_t*)"   now connected    ");
    418          //    }
    419          #endif
    420            }
    421          }
    422          
    423          /******************* (C) COPYRIGHT 2011 STMicroelectronics *****END OF FILE****/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       8   ETH_BSP_Config
         8   -> ETH_GPIO_Config
         8   -> ETH_MACDMA_Config
         8   -> ETH_NVIC_Config
      16   ETH_GPIO_Config
        16   -> GPIO_Init
        16   -> GPIO_PinAFConfig
        16   -> GPIO_StructInit
        16   -> RCC_AHB1PeriphClockCmd
        16   -> RCC_APB2PeriphClockCmd
        16   -> SYSCFG_CompensationCellCmd
        16   -> SYSCFG_ETH_MediaInterfaceConfig
     192   ETH_MACDMA_Config
       192   -> ETH_DMAITConfig
       192   -> ETH_DeInit
       192   -> ETH_GetSoftwareResetStatus
       192   -> ETH_Init
       192   -> ETH_SoftwareReset
       192   -> ETH_StructInit
       192   -> RCC_AHB1PeriphClockCmd
       8   ETH_NVIC_Config
         8   -> NVIC_Init
         8   -> NVIC_PriorityGroupConfig
      24   Eth_Link_EXTIConfig
        24   -> EXTI_Init
        24   -> GPIO_Init
        24   -> NVIC_Init
        24   -> NVIC_PriorityGroupConfig
        24   -> RCC_AHB1PeriphClockCmd
        24   -> RCC_APB2PeriphClockCmd
        24   -> SYSCFG_EXTILineConfig
       8   Eth_Link_ITHandler
         8   -> ETH_ReadPHYRegister
      16   Eth_Link_PHYITConfig
        16   -> ETH_ReadPHYRegister
        16   -> ETH_WritePHYRegister


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable3
       4  ??DataTable3_1
       4  ??DataTable3_2
       4  ??DataTable3_3
       4  ??DataTable3_4
       4  ??DataTable3_5
       4  ??DataTable3_6
      16  ETH_BSP_Config
     602  ETH_GPIO_Config
     162  ETH_MACDMA_Config
      42  ETH_NVIC_Config
       4  EthInitStatus
       1  EthLinkStatus
     128  Eth_Link_EXTIConfig
      30  Eth_Link_ITHandler
      86  Eth_Link_PHYITConfig

 
     5 bytes in section .bss
 1 094 bytes in section .text
 
 1 094 bytes of CODE memory
     5 bytes of DATA memory

Errors: none
Warnings: 1
